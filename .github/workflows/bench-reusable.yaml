name: Reusable Bench Workflow

on:
  workflow_call:
    inputs:
      os:
        required: true
        type: string
        description: "Operating system to build benches on"
      ocaml_version:
        required: false
        type: string
        default: "4.14.2"
        description: "OCaml version to use"
      cache-prefix:
        required: false
        type: string
        default: ""
        description: "Cache prefix for the build"
      rustflags:
        required: false
        type: string
        default: ""
        description: "Additional RUSTFLAGS to append (e.g., macOS-specific linker flags)"

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: full
  MINA_PANIC_ON_BUG: true
  CARGO_INCREMENTAL: 1
  RUSTFLAGS: "-C overflow-checks=off -C debug-assertions=off"

jobs:
  build-benches:
    timeout-minutes: 60
    runs-on: ${{ inputs.os }}
    env:
      RUSTFLAGS: "-C overflow-checks=off -C debug-assertions=off ${{ inputs.rustflags }}"
    steps:
      - name: Git checkout
        uses: actions/checkout@v5

      - name: Setup build dependencies
        uses: ./.github/actions/setup-build-deps

      - name: Use shared OCaml setting up steps
        uses: ./.github/actions/setup-ocaml
        with:
          ocaml_version: ${{ inputs.ocaml_version }}

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          toolchain: 1.84
          cache-prefix: bench-${{ inputs.os }}-${{ inputs.cache-prefix }}v0

      - name: Build all benchmarks
        run: make build-benches
