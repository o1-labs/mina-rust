# =============================================================================
# Mina Rust Frontend Docker Image
# =============================================================================
#
# This Dockerfile creates a production-ready Apache HTTP server image that
# serves the Mina frontend application.
#
# IMAGE STAGES:
# 1. build_wasm - Builds WebAssembly files for web node functionality
# 2. wasm_files - Extracts only WASM artifacts (size optimization)
# 3. final - Apache HTTP server with source code and runtime build capability
#
# FEATURES:
# - Runtime frontend building based on environment variable
# - Pre-built WASM files for Mina web node
# - Environment-specific configuration support (local, webnode, prod, etc.)
# - Caching optimization for web assets
# - WebRTC signaling configuration
#
# BUILD ARGUMENTS:
# None - all configuration is done at runtime via environment variables
#
# REQUIRED FILES:
# .env.docker - Environment variables for VERGEN (git information)
#               Generated by running: ./generate-docker-env.sh
#
# REQUIRED ENVIRONMENT VARIABLES:
# MINA_FRONTEND_ENVIRONMENT - Frontend configuration (local|webnode|production|fuzzing|staging)
#
# USAGE:
# # Generate .env.docker with current git information
# ./generate-docker-env.sh
#
# # Build frontend image
# docker build -t mina-frontend -f frontend/Dockerfile .
#
# # Run with specific environment (MINA_FRONTEND_ENVIRONMENT is REQUIRED)
# docker run -p 80:80 -e MINA_FRONTEND_ENVIRONMENT=webnode mina-frontend
# docker run -p 80:80 -e MINA_FRONTEND_ENVIRONMENT=local mina-frontend
# docker run -p 80:80 -e MINA_FRONTEND_ENVIRONMENT=production mina-frontend
#
# =============================================================================

# Build stage for WASM files
FROM rust:1.84.0-bullseye AS build_wasm

# Install system dependencies required for building the wasm files
# hadolint ignore=DL3008
RUN apt-get update && apt-get install -y --no-install-recommends \
    pkg-config \
    libssl-dev \
    protobuf-compiler \
    make \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /workspace

# Copy Makefile, environment file, and setup WASM toolchain
COPY Makefile ./
COPY .env.docker ./
RUN make setup-wasm

# Copy source code required for WASM build
COPY Cargo.toml Cargo.lock ./
COPY cli ./cli
COPY core ./core
COPY fuzzer ./fuzzer
COPY genesis_ledgers ./genesis_ledgers
COPY ledger ./ledger
COPY macros ./macros
COPY mina-p2p-messages ./mina-p2p-messages
COPY node ./node
COPY p2p ./p2p
COPY poseidon ./poseidon
COPY snark ./snark
COPY tools ./tools
COPY vendor ./vendor
COPY vrf ./vrf

# Build WebAssembly using Makefile (source VERGEN variables from .env.docker)
RUN bash -c 'set -a && source .env.docker && make build-wasm'

# WASM files extraction stage
FROM scratch AS wasm_files
WORKDIR /pkg
COPY --from=build_wasm /workspace/pkg ./

# Final stage - Apache with source code and build capability
FROM httpd:2.4 AS final

# Install system dependencies required for Node.js and build tools
# hadolint ignore=DL3008
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        curl \
        ca-certificates \
        gnupg \
        make \
        && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy documentation scripts for Node.js setup
COPY ./website/docs/developers/scripts/frontend/install-nodejs-linux.sh ./scripts/install-nodejs-linux.sh
COPY ./website/docs/developers/scripts/frontend/install-angular-cli.sh ./scripts/install-angular-cli.sh

# Install Node.js and Angular CLI using documentation scripts
RUN chmod +x ./scripts/*.sh && \
    bash ./scripts/install-nodejs-linux.sh && \
    bash -c 'source "$HOME/.nvm/nvm.sh" && bash ./scripts/install-angular-cli.sh'

# Copy entire frontend source code and Makefile
COPY frontend/ ./frontend/
COPY Makefile ./

# Copy Apache configuration
COPY frontend/httpd.conf /usr/local/apache2/conf/httpd.conf

# Copy WASM files from build stage
COPY --from=wasm_files . /usr/local/apache2/htdocs/assets/webnode/pkg/

# Copy circuit blobs for devnet and mainnet from local directory
COPY circuit-blobs/3.0.1devnet /usr/local/apache2/htdocs/assets/webnode/circuit-blobs/3.0.1devnet
COPY circuit-blobs/3.0.0mainnet /usr/local/apache2/htdocs/assets/webnode/circuit-blobs/3.0.0mainnet

# Create startup script and setup directories
COPY ./frontend/docker/startup.sh /usr/local/bin/startup.sh
RUN chmod +x /usr/local/bin/startup.sh && \
    mkdir -p /usr/local/apache2/htdocs

# Install frontend dependencies using Makefile
WORKDIR /app/frontend
RUN bash -c 'source "$HOME/.nvm/nvm.sh" && make install-deps'

WORKDIR /app

# MINA_FRONTEND_ENVIRONMENT is mandatory and must be set at runtime

ENTRYPOINT ["/usr/local/bin/startup.sh"]
CMD ["httpd-foreground"]
